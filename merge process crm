/*Пример сборки датасета от CRM обновляемого по новым строкам*/


--Вставка всех строк при копировании или добавлении полей, изменении их архитектуры
INSERT INTO
  raiffeisen-owox.CRM.order_tmp (_PARTITIONTIME,ORDER_ID, APP_ID, LEAD_DATE, PRODUCT_LINE, PRODUCT, NTB, GOOGLE_ID, UTM_MEDIUM, UTM_SOURCE, UTM_CAMPAIGN, UTM_CONTENT, UTM_TERM, SEGMENT_REQUEST_LIMIT, SEGMENT_ISSUES_LIMIT, STATUSES, SALE_CH_CODE, PROCESSING_CHANNEL)
SELECT
 TIMESTAMP_TRUNC(LeadDate, DAY) d, leadid e, leadid, LeadDate, PRODUCT_LINE a, PRODUCT_LINE b, NTB , GOOGLE_ID, UTM_MEDIUM, UTM_SOURCE, UTM_CAMPAIGN, UTM_CONTENT, utm_term, segmentRequestLimit, STAT.SEGMENTISSUESLIMIT,[STRUCT(DATE( LeadDate ), STAT.STATUS, STAT.APPROVAL)], STAT.SALE_CH_CODE, STAT.PROCESSING_CHANNEL
  FROM (SELECT * 
FROM `raiffeisen-owox.Orders_CRM.crm_orders_2019_base_d`
WHERE LeadDate > "2020-05-24") CRM
LEFT JOIN (SELECT STAT FROM Orders_CRM.crm_orders_2019_other STAT) ON leadid = STAT.LEADID


--Ежедневный инкремент новых записеей
MERGE raiffeisen-owox.CRM.order_tmp  T
USING ( 
    SELECT * 
    FROM `raiffeisen-owox.Orders_CRM.crm_orders_2019_base_d`
    LEFT JOIN (SELECT STAT FROM `raiffeisen-owox.Orders_CRM.crm_orders_2019_other` STAT) ON leadid = STAT.LEADID  
) S ON T.ORDER_ID = S.leadid AND T._PARTITIONTIME >= '2019-01-01'
WHEN NOT MATCHED  THEN
  INSERT
  (_PARTITIONTIME,ORDER_ID, APP_ID, LEAD_DATE, PRODUCT_LINE, PRODUCT, NTB, GOOGLE_ID, UTM_MEDIUM, UTM_SOURCE, UTM_CAMPAIGN, UTM_CONTENT, UTM_TERM, SEGMENT_REQUEST_LIMIT, SEGMENT_ISSUES_LIMIT, STATUSES, SALE_CH_CODE, PROCESSING_CHANNEL)
  VALUES(TIMESTAMP_TRUNC(LeadDate, DAY), leadid , leadid, LeadDate, PRODUCT_LINE , PRODUCT_LINE , NTB , GOOGLE_ID, UTM_MEDIUM, UTM_SOURCE, UTM_CAMPAIGN, UTM_CONTENT, utm_term, segmentRequestLimit, STAT.SEGMENTISSUESLIMIT,[STRUCT(DATE( LeadDate ), STAT.STATUS, STAT.APPROVAL)], STAT.SALE_CH_CODE, STAT.PROCESSING_CHANNEL)
  
  
--Обновление записей в структурных талицах
MERGE CRM.order_tmp T  
USING (
  SELECT DISTINCT LEADID, STATUS, APPROVAL FROM  Orders_CRM.crm_orders_2019_other 
    JOIN (SELECT DISTINCT ORDER_ID, ST.STATUS as STAT , ST.APPROVAL as AP FROM `raiffeisen-owox.CRM.orders` r, r.STATUSES as ST WHERE DATE(_PARTITIONTIME) >= "2018-01-01") ON ORDER_ID = LEADID AND ( STATUS <> STAT OR APPROVAL <> AP)
) S
ON T.ORDER_ID = S.LEADID AND T._PARTITIONTIME >= '2019-01-01'
WHEN MATCHED THEN
  UPDATE SET STATUSES = ARRAY_CONCAT( STATUSES ,[STRUCT(CURRENT_DATE(), S.STATUS, S.APPROVAL )])
  
  
-- Обновление через доп вью
MERGE CRM.order_tmp T  
USING CRM.MD_NewStatuses S
ON T.ORDER_ID = S.LEADID AND T._PARTITIONTIME >= '2019-01-01'
WHEN MATCHED THEN
  UPDATE SET STATUSES = ARRAY_CONCAT( STATUSES ,[STRUCT(CURRENT_DATE(), S.STATUS, S.APPROVAL )])
  
  
--Удаление записи в статусах по дате
UPDATE CRM.orders T  
SET STATUSES = ARRAY(SELECT x
        FROM UNNEST(STATUSES) AS x
        WHERE x.UPD_DATE != "2020-05-29")
WHERE DATE(_PARTITIONTIME) >= "2019-01-01" 
AND EXISTS (SELECT 1 FROM UNNEST(STATUSES) WHERE UPD_DATE = "2020-05-29")
AND ARRAY_LENGTH(STATUSES)>1
